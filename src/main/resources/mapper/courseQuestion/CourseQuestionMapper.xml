<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.lms.mapper.courseQuestion.CourseQuestionMapper">

    <!-- 전체 질문 개수 -->
    <select id="countQuestion" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM tb_course_question
        WHERE course_no = #{courseNo}
    </select>

    <!-- 페이징 목록 조회 -->
    <select id="selectPagedQuestionList" resultType="com.example.lms.dto.CourseQuestionDTO">
        SELECT 
              q.course_question_no   AS courseQuestionNo
            , q.course_no            AS courseNo
            , q.writer_user_no       AS writerUserNo
            , u.user_name            AS writerName
            , q.course_question_title AS courseQuestionTitle
            , q.course_question_status AS courseQuestionStatus
            , q.createdate           AS createdate
            , q.is_private           AS privatePost
            , (SELECT COUNT(*)
                 FROM tb_course_question_answer a
                 WHERE a.course_question_no = q.course_question_no) > 0 AS answered
        FROM tb_course_question q
        LEFT JOIN tb_sysuser u ON q.writer_user_no = u.user_no
        WHERE q.course_no = #{courseNo}
        ORDER BY q.createdate DESC
        LIMIT #{startRow}, #{rowPerPage}
    </select>

    <!-- 문의 목록 조회 -->
    <select id="selectQuestionList" resultType="com.example.lms.dto.CourseQuestionDTO">
        SELECT 
              q.course_question_no   AS courseQuestionNo
            , q.course_no            AS courseNo
            , q.writer_user_no       AS writerUserNo
            , u.user_name            AS writerName
            , 'STUDENT'              AS writerRole
            , q.course_question_title AS courseQuestionTitle
            , q.course_question_status AS courseQuestionStatus
            , q.createdate           AS createdate
            , q.is_private           AS privatePost
            , (SELECT COUNT(*) 
                 FROM tb_course_question_answer a 
                 WHERE a.course_question_no = q.course_question_no) > 0 AS answered
        FROM tb_course_question q
        LEFT JOIN tb_sysuser u ON q.writer_user_no = u.user_no
        WHERE q.course_no = #{courseNo}
        ORDER BY q.createdate DESC
    </select>

    <!-- 문의 상세 조회 -->
    <select id="selectQuestionDetail" parameterType="int"
            resultType="com.example.lms.dto.CourseQuestionDTO">
        SELECT
              q.course_question_no    AS courseQuestionNo
            , q.course_no             AS courseNo
            , q.writer_user_no        AS writerUserNo
            , u.user_name             AS writerName
            , 'STUDENT'               AS writerRole
            , q.course_question_title AS courseQuestionTitle
            , q.course_question_content AS courseQuestionContent
            , q.course_question_status AS courseQuestionStatus
            , q.createdate            AS createdate
            , q.is_private            AS privatePost
            , (SELECT COUNT(*)
                 FROM tb_course_question_answer a
                 WHERE a.course_question_no = q.course_question_no) > 0 AS answered
        FROM tb_course_question q
        LEFT JOIN tb_sysuser u ON q.writer_user_no = u.user_no
        WHERE q.course_question_no = #{courseQuestionNo}
    </select>

    <!-- 댓글 리스트 -->
    <select id="selectAnswerList" parameterType="int"
            resultType="com.example.lms.dto.CourseQuestionAnswerDTO">
        SELECT
              a.answer_no            AS answerNo
            , a.course_question_no   AS courseQuestionNo
            , a.writer_user_no       AS writerUserNo
            , u.user_name            AS writerName
            , a.writer_role          AS writerRole
            , a.answer_content       AS answerContent
            , a.createdate           AS createdate
        FROM tb_course_question_answer a
        LEFT JOIN tb_sysuser u ON a.writer_user_no = u.user_no
        WHERE a.course_question_no = #{courseQuestionNo}
        ORDER BY a.createdate ASC
    </select>

    <!-- 문의글 INSERT -->
    <insert id="insertQuestion" parameterType="com.example.lms.dto.CourseQuestionDTO">
        INSERT INTO tb_course_question (
            course_no, writer_user_no, course_question_title,
            course_question_content, course_question_status, is_private
        )
        VALUES (
            #{courseNo}, #{writerUserNo}, #{courseQuestionTitle},
            #{courseQuestionContent}, 0, #{privatePost}
        )
    </insert>

    <!-- 댓글 INSERT -->
    <insert id="insertAnswer">
        INSERT INTO tb_course_question_answer (
            course_question_no, writer_user_no, writer_role,
            answer_content, createdate
        )
        VALUES (
            #{courseQuestionNo}, #{writerUserNo}, #{writerRole},
            #{answerContent}, NOW()
        )
    </insert>

    <!-- 본인 글 여부 체크 -->
    <select id="isOwner" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM tb_course_question
        WHERE course_question_no = #{courseQuestionNo}
          AND writer_user_no = #{userNo}
    </select>

    <!-- 문의글 수정 -->
    <update id="updateQuestion" parameterType="com.example.lms.dto.CourseQuestionDTO">
        UPDATE tb_course_question
        SET 
            course_question_title = #{courseQuestionTitle},
            course_question_content = #{courseQuestionContent},
            is_private = #{privatePost}
        WHERE course_question_no = #{courseQuestionNo}
    </update>

    <!-- 문의글 삭제 -->
    <delete id="deleteQuestion">
        DELETE FROM tb_course_question
        WHERE course_question_no = #{courseQuestionNo}
    </delete>

    <!-- 특정 문의글의 courseNo 조회 -->
    <select id="selectCourseNoByQuestion" parameterType="int" resultType="int">
        SELECT course_no
        FROM tb_course_question
        WHERE course_question_no = #{courseQuestionNo}
    </select>

    <!-- 교수 댓글 소유자 체크 -->
    <select id="isAnswerOwner" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM tb_course_question_answer
        WHERE answer_no = #{answerNo}
          AND writer_user_no = #{profNo}
    </select>

    <!-- 교수 댓글 수정 -->
    <update id="updateAnswer" parameterType="com.example.lms.dto.CourseQuestionAnswerDTO">
        UPDATE tb_course_question_answer
        SET 
            answer_content = #{answerContent},
            updatedate = NOW()
        WHERE answer_no = #{answerNo}
    </update>

</mapper>
