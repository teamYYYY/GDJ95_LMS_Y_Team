<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.lms.mapper.enrollment.EnrollmentMapper">

    <!-- 1) 취소 → 재신청 -->
    <update id="reactivateEnrollment">
        UPDATE tb_enrollment
        SET enrollment_status = 0
          , updatedate = NOW()
        WHERE student_user_no = #{studentUserNo}
          AND course_no = #{courseNo}
          AND enrollment_status = 1
    </update>

    <!-- 2) 신규 수강신청 -->
    <insert id="insertEnrollment">
        INSERT INTO tb_enrollment
        ( student_user_no
        , course_no
        , enrollment_status
        , createdate )
        VALUES
        ( #{studentUserNo}
        , #{courseNo}
        , #{enrollmentStatus}
        , NOW() )
    </insert>

    <!-- 3) 중복 체크 -->
    <select id="countEnrollment" resultType="int">
        SELECT COUNT(*)
        FROM tb_enrollment
        WHERE student_user_no = #{studentUserNo}
          AND course_no = #{courseNo}
          AND enrollment_status = 0
    </select>

    <!-- 4) 수강신청 목록 조회 -->
    <select id="selectEnrollmentList" resultType="com.example.lms.dto.EnrollmentDTO">
        SELECT enrollment_no enrollmentNo
             , student_user_no studentUserNo
             , course_no courseNo
             , enrollment_status enrollmentStatus
             , createdate
             , updatedate
        FROM tb_enrollment
        WHERE student_user_no = #{studentUserNo}
        ORDER BY createdate DESC
    </select>

    <!-- 5) 수강취소 -->
    <update id="cancelEnrollment">
        UPDATE tb_enrollment
        SET enrollment_status = 1
          , updatedate = NOW()
        WHERE student_user_no = #{studentUserNo}
          AND course_no = #{courseNo}
          AND enrollment_status = 0
    </update>

</mapper>
