<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.lms.mapper.user.UserMapper">

	<!-- 2025. 11. 25. JM. 개인정보 관리 - 기본정보 -->
	<select id="userInfoMap" parameterType="com.example.lms.dto.SysUserDTO" resultType="java.util.Map">
		
		SELECT
		    a.user_no            AS userNo,
		    a.user_id            AS userId,
		    a.user_auth          AS userAuth,
		    b.auth_detail_name	 AS authDetailName,
		    c.auth_code 		 AS authCode,
		    c.auth_name			 AS authName,
		    a.user_status        AS userStatus,
		    e.status_name		 AS statusName,
		    a.user_name          AS userName,
		    a.user_password      AS userPassword,
		    a.user_email       AS userEmail,
		    a.user_phone      AS userPhone,
		    a.user_birth       AS userBirth,
		    a.dept_code          AS deptCode,
		    d.dept_name			 AS deptName,
		    a.user_grade         AS userGrade,
		    f.grade_name 		 AS gradeName,
			a.user_addr        AS userAddr,
			a.user_addr_detail AS userAddrDetail,
			a.user_zipcode     AS userZipcode,
		    a.user_last_login    AS userLastLogin,
		    a.user_login_fail_cnt 	AS userLoginFailCnt,
		    a.user_createdate         AS createDate,
		    a.user_updatedate         AS updateDate
		FROM tb_sysuser a
		INNER JOIN tb_sysauth_detail b ON
		a.user_auth = b.auth_detail_code
		INNER JOIN tb_sysauth c 
		ON b.auth_code = c.auth_code
		INNER JOIN tb_dept d 
		ON a.dept_code = d.dept_code
		INNER JOIN tb_sysuser_status e
		ON a.user_status = e.status_code
		LEFT OUTER JOIN tb_sysuser_grade f
		ON a.user_grade = f.grade_code
		WHERE a.user_no = #{userNo} and a.user_id = #{userId}
		
	</select>
	
	
	<!-- 2025. 11. 25. JM. 개인정보 관리 - 기본정보 수정 -->
	<update id="updateUserInfo" parameterType="com.example.lms.dto.SysUserDTO">
	
		UPDATE
			tb_sysuser
		SET
			user_email = #{userEmail},
			user_phone = #{userPhone},
			user_addr = #{userAddr},
			user_addr_detail = #{userAddrDetail},
			user_zipcode = #{userZipcode},
			user_login_fail_cnt = 0,
			user_updatedate = NOW()
		WHERE
			user_no = #{userNo}
			AND user_id = #{userId}
	
	</update>
	
	<!-- 2025. 11. 25. JM. 개인정보 관리 - 비밀번호 수정 -->
	<update id="modifyUserInfoPassword" parameterType="java.util.Map">
	
		UPDATE
			tb_sysuser
		SET
			user_password = #{userNewPassword},
			user_updatedate = NOW()
		WHERE
			user_no = #{userNo}
			and user_id = #{userId}
			and user_password = #{userPassword}
	
	</update>
	
	<!-- 2025. 11. 25. JM. 시스템사용자 관리 - 사용자 전체 조회 1페이지 10명단위 -->
	<select id="userInfoMapList" resultType="java.util.Map">
		
		SELECT
		    a.user_no            AS userNo,
		    a.user_id            AS userId,
		    a.user_auth          AS userAuth,
		    b.auth_detail_name	 AS authDetailName,
		    c.auth_code 		 AS authCode,
		    c.auth_name			 AS authName,
		    a.user_status        AS userStatus,
		    e.status_name		 AS statusName,
		    a.user_name          AS userName,
		    a.user_password      AS userPassword,
		    a.user_email       AS userEmail,
		    a.user_phone      AS userPhone,
		    a.user_birth       AS userBirth,
		    a.dept_code          AS deptCode,
		    d.dept_name			 AS deptName,
		    a.user_grade         AS userGrade,
		    f.grade_name 		 AS gradeName,
			a.user_addr        AS userAddr,
			a.user_addr_detail AS userAddrDetail,
			a.user_zipcode     AS userZipcode,
		    a.user_last_login    AS userLastLogin,
		    a.user_login_fail_cnt 	AS userLoginFailCnt,
		    a.user_createdate         AS createDate,
		    a.user_updatedate         AS updateDate
		FROM tb_sysuser a
		INNER JOIN tb_sysauth_detail b ON
		a.user_auth = b.auth_detail_code
		INNER JOIN tb_sysauth c 
		ON b.auth_code = c.auth_code
		INNER JOIN tb_dept d 
		ON a.dept_code = d.dept_code
		INNER JOIN tb_sysuser_status e
		ON a.user_status = e.status_code
		LEFT OUTER JOIN tb_sysuser_grade f
		ON a.user_grade = f.grade_code
		ORDER BY a.user_no DESC
		LIMIT #{startRow}, #{limit}
		
	</select>
	
	<!-- 2025. 11. 25. JM. 시스템사용자 관리 - 사용자 등록 -->
	<insert id="insertUserInfo" parameterType="com.example.lms.dto.SysUserDTO">
	
		INSERT INTO tb_sysuser (
			  user_id,
			  user_auth,
			  user_status,
			  user_name,
			  user_password,
			  user_email,
			  user_phone,
			  user_birth,
			  dept_code,
			  user_grade,
			  user_addr,
			  user_addr_detail,
			  user_zipcode,
			  user_last_login,
			  user_login_fail_cnt,
			  user_createdate,
			  user_updatedate
		 ) VALUES (
			  #{userId},
			  #{userAuth},
			  #{userStatus},
			  #{userName},
			  #{userPassword},
			  #{userEmail},
			  #{userPhone},
			  #{userBirth},
			  #{deptCode},
			  #{userGrade},
			  #{userAddr},
			  #{userAddrDetail},
			  #{userZipcode},
			  NULL,
			  '0',
			  NOW(),
			  NOW()
		  )
	
	</insert>
	
	<!-- 2025. 11. 25. JM. 시스템사용자 관리 - 시스템 사용자 정보 수정 -->
	<update id="updateUserInfoByAdmin" parameterType="com.example.lms.dto.SysUserDTO">
		
		UPDATE
			tb_sysuser
		SET
			user_id = #{userId},
			user_status = #{userStatus},
			user_auth = #{userAuth},
			user_name = #{userName},
			<if test="userPassword != null and userPassword != ''">
            user_password = #{userPassword},
        	</if>
			user_email = #{userEmail},
			user_phone = #{userPhone},
			user_birth = #{userBirth},
			dept_code = #{deptCode},
			user_grade = #{userGrade},
			user_addr = #{userAddr},
			user_addr_detail = #{userAddrDetail},
			user_zipcode = #{userZipcode},
			user_login_fail_cnt = #{userLoginFailCnt},
			user_updatedate = NOW()
		WHERE
			user_no = #{userNo}
			AND user_id = #{userId}
	
	</update>
	
	<!-- 2025. 11. 25. JM. 시스템사용자 관리 - 시스템 사용자 검색 조회 -->
	<select id="searchUserInfoMapList" parameterType="String" resultType="java.util.Map">
		
		SELECT
		    a.user_no            AS userNo,
		    a.user_id            AS userId,
		    a.user_auth          AS userAuth,
		    b.auth_detail_name	 AS authDetailName,
		    c.auth_code 		 AS authCode,
		    c.auth_name			 AS authName,
		    a.user_status        AS userStatus,
		    e.status_name		 AS statusName,
		    a.user_name          AS userName,
		    a.user_password      AS userPassword,
		    a.user_email       AS userEmail,
		    a.user_phone      AS userPhone,
		    a.user_birth       AS userBirth,
		    a.dept_code          AS deptCode,
		    d.dept_name			 AS deptName,
		    a.user_grade         AS userGrade,
		    f.grade_name 		 AS gradeName,
			a.user_addr        AS userAddr,
			a.user_addr_detail AS userAddrDetail,
			a.user_zipcode     AS userZipcode,
		    a.user_last_login    AS userLastLogin,
		    a.user_login_fail_cnt 	AS userLoginFailCnt,
		    a.user_createdate         AS createDate,
		    a.user_updatedate         AS updateDate
		FROM tb_sysuser a
		INNER JOIN tb_sysauth_detail b ON
		a.user_auth = b.auth_detail_code
		INNER JOIN tb_sysauth c 
		ON b.auth_code = c.auth_code
		INNER JOIN tb_dept d 
		ON a.dept_code = d.dept_code
		INNER JOIN tb_sysuser_status e
		ON a.user_status = e.status_code
		LEFT OUTER JOIN tb_sysuser_grade f
		ON a.user_grade = f.grade_code
		WHERE 1=1
			<if test="searchUserCondition != null and searchUserCondition.trim() != ''">
	        AND (
	               a.user_id LIKE CONCAT('%', #{searchUserCondition}, '%')
	               OR a.user_name LIKE CONCAT('%', #{searchUserCondition}, '%')
	           )
	        </if>
	     ORDER BY a.user_no DESC  
	     LIMIT #{startRow}, #{limit}
		
	</select>
	
	<!-- 2025. 11. 25. JM. 시스템사용자 관리 - 시스템 사용자 검색 조회 카운트 -->
	<select id="searchUserInfoMapListCnt" parameterType="String" resultType="int">
		
		SELECT COUNT(*) FROM (
		SELECT
		    a.user_no            AS userNo,
		    a.user_id            AS userId,
		    a.user_auth          AS userAuth,
		    b.auth_detail_name	 AS authDetailName,
		    c.auth_code 		 AS authCode,
		    c.auth_name			 AS authName,
		    a.user_status        AS userStatus,
		    e.status_name		 AS statusName,
		    a.user_name          AS userName,
		    a.user_password      AS userPassword,
		    a.user_email       AS userEmail,
		    a.user_phone      AS userPhone,
		    a.user_birth       AS userBirth,
		    a.dept_code          AS deptCode,
		    d.dept_name			 AS deptName,
		    a.user_grade         AS userGrade,
		    f.grade_name 		 AS gradeName,
			a.user_addr        AS userAddr,
			a.user_addr_detail AS userAddrDetail,
			a.user_zipcode     AS userZipcode,
		    a.user_last_login    AS userLastLogin,
		    a.user_login_fail_cnt 	AS userLoginFailCnt,
		    a.user_createdate         AS createDate,
		    a.user_updatedate         AS updateDate
		FROM tb_sysuser a
		INNER JOIN tb_sysauth_detail b ON
		a.user_auth = b.auth_detail_code
		INNER JOIN tb_sysauth c 
		ON b.auth_code = c.auth_code
		INNER JOIN tb_dept d 
		ON a.dept_code = d.dept_code
		INNER JOIN tb_sysuser_status e
		ON a.user_status = e.status_code
		LEFT OUTER JOIN tb_sysuser_grade f
		ON a.user_grade = f.grade_code
		WHERE 1=1
			<if test="searchUserCondition != null and searchUserCondition.trim() != ''">
	        AND (
	               a.user_id LIKE CONCAT('%', #{searchUserCondition}, '%')
	               OR a.user_name LIKE CONCAT('%', #{searchUserCondition}, '%')
	           )
	        </if>
		) t
	</select>
	
	<!-- 2025. 11. 26. JM. 시스템사용자 관리 - 시스템 전체 사용자 수 ( 페이징 시 사용 ) -->
	<select id="selectSysUserCnt" resultType="int">
	
		SELECT
			count(*)
		FROM
			(
			SELECT
				a.user_no AS userNo
			FROM tb_sysuser a
			INNER JOIN tb_sysauth_detail b ON
			a.user_auth = b.auth_detail_code
			INNER JOIN tb_sysauth c 
			ON b.auth_code = c.auth_code
			INNER JOIN tb_dept d 
			ON a.dept_code = d.dept_code
			INNER JOIN tb_sysuser_status e
			ON a.user_status = e.status_code
			LEFT OUTER JOIN tb_sysuser_grade f
			ON a.user_grade = f.grade_code ) t
	
	</select>
	
	
	<!-- 2025. 11. 25. JM. 시스템사용자 관리 - 사용자 상세정보 조회 -->
	<select id="userInfoDetailMapList" resultType="java.util.Map">
		
		SELECT
		    a.user_no            AS userNo,
		    a.user_id            AS userId,
		    a.user_auth          AS userAuth,
		    b.auth_detail_name	 AS authDetailName,
		    c.auth_code 		 AS authCode,
		    c.auth_name			 AS authName,
		    a.user_status        AS userStatus,
		    e.status_name		 AS statusName,
		    a.user_name          AS userName,
		    a.user_password      AS userPassword,
		    a.user_email       AS userEmail,
		    a.user_phone      AS userPhone,
		    a.user_birth       AS userBirth,
		    a.dept_code          AS deptCode,
		    d.dept_name			 AS deptName,
		    a.user_grade         AS userGrade,
		    f.grade_name 		 AS gradeName,
			a.user_addr        AS userAddr,
			a.user_addr_detail AS userAddrDetail,
			a.user_zipcode     AS userZipcode,
		    a.user_last_login    AS userLastLogin,
		    a.user_login_fail_cnt 	AS userLoginFailCnt,
		    a.user_createdate         AS createDate,
		    a.user_updatedate         AS updateDate
		FROM tb_sysuser a
		INNER JOIN tb_sysauth_detail b ON
		a.user_auth = b.auth_detail_code
		INNER JOIN tb_sysauth c 
		ON b.auth_code = c.auth_code
		INNER JOIN tb_dept d 
		ON a.dept_code = d.dept_code
		INNER JOIN tb_sysuser_status e
		ON a.user_status = e.status_code
		LEFT OUTER JOIN tb_sysuser_grade f
		ON a.user_grade = f.grade_code
		WHERE a.user_id = #{userId}  
		
	</select>
	
	<!-- 2025. 11. 26. JM. 시스템사용자 관리 - 다수 사용자 계정 폐지 처리 기능 3 폐지-->
	<update id="modifySysUserStatusRetire" parameterType="java.util.List">
	
		UPDATE
			tb_sysuser
		SET
			user_status = '3'
		WHERE user_no IN 
		<foreach collection="list" item="item" open="(" separator="," close=")">
       		 #{item}
   		</foreach>
	
	</update>

</mapper>