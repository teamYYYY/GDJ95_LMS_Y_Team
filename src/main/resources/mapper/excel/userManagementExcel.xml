<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.lms.mapper.excel.userManagementExcelMapper">

	<!-- 2025. 12. 01. JM. 시스템사용자 관리 - 시스템 사용자 검색 조회 -->
	<select id="searchUserInfoMapListForExcel" parameterType="String" resultType="java.util.Map">
		
		SELECT
		    a.user_no            AS userNo,
		    a.user_id            AS userId,
		    a.user_auth          AS userAuth,
		    b.auth_detail_name	 AS authDetailName,
		    c.auth_code 		 AS authCode,
		    c.auth_name			 AS authName,
		    a.user_status        AS userStatus,
		    e.status_name		 AS statusName,
		    a.user_name          AS userName,
		    a.user_password      AS userPassword,
		    a.user_email       AS userEmail,
		    a.user_phone      AS userPhone,
		    a.user_birth       AS userBirth,
		    a.dept_code          AS deptCode,
		    d.dept_name			 AS deptName,
		    a.user_grade         AS userGrade,
		    f.grade_name 		 AS gradeName,
			a.user_addr        AS userAddr,
			a.user_addr_detail AS userAddrDetail,
			a.user_zipcode     AS userZipcode,
		    a.user_last_login    AS userLastLogin,
		    a.user_login_fail_cnt 	AS userLoginFailCnt,
		    a.user_createdate         AS createDate,
		    a.user_updatedate         AS updateDate
		FROM tb_sysuser a
		INNER JOIN tb_sysauth_detail b ON
		a.user_auth = b.auth_detail_code
		INNER JOIN tb_sysauth c 
		ON b.auth_code = c.auth_code
		INNER JOIN tb_dept d 
		ON a.dept_code = d.dept_code
		INNER JOIN tb_sysuser_status e
		ON a.user_status = e.status_code
		LEFT OUTER JOIN tb_sysuser_grade f
		ON a.user_grade = f.grade_code
		WHERE 1=1
			<if test="searchUserCondition != null and searchUserCondition.trim() != ''">
	        AND (
	               a.user_id LIKE CONCAT('%', #{searchUserCondition}, '%')
	               OR a.user_name LIKE CONCAT('%', #{searchUserCondition}, '%')
	           )
	        </if>
	     ORDER BY a.user_no DESC
		
	</select>
	
	<!-- 2025. 12. 01. JM. 엑셀로 다수 사용자 등록 시 검증 필요함 - 1. 권한코드 검증 필요 -->
	<select id="sysAuthDetailCdValidateExcel">
		
		SELECT
			count(b.auth_code)
		FROM
			tb_sysauth_detail a
		INNER JOIN tb_sysauth b ON
			a.auth_code = b.auth_code
		WHERE a.auth_detail_code = #{userAuth}
	
	</select>
	
	<!-- 2025. 12. 01. JM. 엑셀로 다수 사용자 등록 시 검증 필요함 - 2. 학년코드 검증 필요 -->
	<select id="sysUserGradeCdValidateExcel">
	
		SELECT
			grade_code
		FROM
			tb_sysuser_grade
		WHERE
			grade_code = #{gradeCode}
	
	</select>
	
	<!-- 2025. 12. 01. JM. 엑셀로 다수 사용자 등록 시 검증 필요함 - 2_1. 학생인지 검증 필요 -->
	<select id="sysUserGradeCdValidateExcel2">
		
		SELECT
			count(b.auth_code)
		FROM
			tb_sysauth_detail a
		INNER JOIN tb_sysauth b ON
			a.auth_code = b.auth_code
		WHERE a.auth_detail_code = #{userAuth}
		AND b.auth_code = 'S001'
	
	</select>
	
	<!-- 2025. 12. 01. JM. 엑셀로 다수 사용자 등록 시 검증 필요함 - 3. 학과,소속코드 검증 필요 -->
	<select id="deptCdValidateExcel">
	
		SELECT
			dept_code AS deptCode
		FROM
			tb_dept
		WHERE dept_code = #{deptCode}
	
	</select>
	
	<!-- 2025. 12. 01. JM. 엑셀로 다수 사용자 등록 시 검증 필요함 - 4. 계정상태코드 검증 필요 -->
	<select id="sysUserStatusCdValidateExcel">
	
		SELECT
			status_code as statusCode
		FROM 
			tb_sysuser_status
		WHERE status_code = #{statusCode}
	
	</select>
	
	<!-- 2025. 12. 01. JM. 시스템사용자관리 - 사용자 등록 -->
	<insert id="insertUserInfoForExcel">
	
		INSERT INTO tb_sysuser (
				  user_id,
				  user_auth,
				  user_status,
				  user_name,
				  user_password,
				  user_email,
				  user_phone,
				  user_birth,
				  dept_code,
				  user_grade,
				  user_addr,
				  user_addr_detail,
				  user_zipcode,
				  user_last_login,
				  user_login_fail_cnt,
				  user_createdate,
				  user_updatedate
			 ) VALUES (
				  #{userId},
				  #{userAuth},
				  #{userStatus},
				  #{userName},
				  #{userPassword},
				  #{userEmail},
				  #{userPhone},
				  #{userBirth},
				  #{deptCode},
				  #{userGrade},
				  #{userAddr},
				  #{userAddrDetail},
				  #{userZipcode},
				  #{userLastLogin},
				  #{userLoginFailCnt},
				  NOW(),
				  NOW()
			  )
	
	</insert>
	

</mapper>