<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.lms.mapper.studentCourse.StudentCourseMapper">

    <!-- 학생용 수강신청 화면 강의 목록 조회 -->
    <select id="selectCourseListForStudent"
        resultType="com.example.lms.dto.StudentCourseDTO">
	
	    SELECT
		      c.course_no AS courseNo
		    , c.course_name AS courseName
		    , u.user_name AS professorName
		    , c.course_score AS courseScore
		    , c.course_capacity AS courseCapacity
		
		    -- ★ TB_COURSE_TIME에서 1개만 가져오기
		    , (
		        SELECT t.course_time_yoil
		        FROM tb_course_time t
		        WHERE t.course_no = c.course_no
		        ORDER BY t.course_time_yoil ASC
		        LIMIT 1
		      ) courseTimeYoil
		
		    , (
		        SELECT t.course_time_start
		        FROM tb_course_time t
		        WHERE t.course_no = c.course_no
		        ORDER BY t.course_time_yoil ASC
		        LIMIT 1
		      ) courseTimeStart
		
		    , (
		        SELECT t.course_time_end
		        FROM tb_course_time t
		        WHERE t.course_no = c.course_no
		        ORDER BY t.course_time_yoil ASC
		        LIMIT 1
		      ) courseTimeEnd
		
		    -- 수강 현황
		    , IFNULL(e.current_count, 0) AS currentCount
		    , CASE
		        WHEN IFNULL(e.current_count, 0) >= c.course_capacity
		            THEN TRUE ELSE FALSE
		      END AS isFull
		
		FROM tb_course c
		LEFT JOIN tb_sysuser u
		    ON c.professor_user_no = u.user_no
		
		LEFT JOIN (
		    SELECT course_no, COUNT(*) current_count
		    FROM tb_enrollment
		    WHERE enrollment_status = 0
		    GROUP BY course_no
		) e ON c.course_no = e.course_no
		
		ORDER BY c.course_no DESC;
	</select>

    


    <!-- 강의 정원 조회 -->
    <select id="getCourseCapacity"
            parameterType="int"
            resultType="int">
        SELECT
              c.course_capacity
        FROM tb_course c
        WHERE c.course_no = #{courseNo}
    </select>


    <!-- 특정 강의의 현재 신청 인원 조회 -->
    <select id="getCurrentEnrollment"
            parameterType="int"
            resultType="int">
        SELECT
              COUNT(*)
        FROM tb_enrollment e
        WHERE e.course_no = #{courseNo}
          AND e.enrollment_status = 0
    </select>

</mapper>
