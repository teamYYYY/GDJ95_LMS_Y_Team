<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.lms.mapper.studentCourse.StudentCourseMapper">

    <!-- 학생용 강의 목록 조회 (수강신청 화면) -->
    <select id="selectCourseListForStudent"
            resultType="com.example.lms.dto.StudentCourseDTO">

        SELECT
              c.course_no courseNo
            , c.course_name courseName
            , u.user_name professorName
            , c.course_score courseScore
            , c.course_capacity courseCapacity

            , (
                SELECT CASE t.course_time_yoil
                        WHEN 1 THEN '월'
                        WHEN 2 THEN '화'
                        WHEN 3 THEN '수'
                        WHEN 4 THEN '목'
                        WHEN 5 THEN '금'
                      END
                FROM tb_course_time t
                WHERE t.course_no = c.course_no
                ORDER BY t.course_time_yoil
                LIMIT 1
            ) courseTimeYoil

            , (
                SELECT t.course_time_start
                FROM tb_course_time t
                WHERE t.course_no = c.course_no
                ORDER BY t.course_time_yoil
                LIMIT 1
            ) courseTimeStart

            , (
                SELECT t.course_time_end
                FROM tb_course_time t
                WHERE t.course_no = c.course_no
                ORDER BY t.course_time_yoil
                LIMIT 1
            ) courseTimeEnd

            , IFNULL(e.current_count, 0) currentCount
            , (IFNULL(e.current_count, 0) >= c.course_capacity) isFull

            , s.enrollment_status myStatus

        FROM tb_course c
        LEFT JOIN tb_sysuser u ON u.user_no = c.professor_user_no

        LEFT JOIN (
            SELECT course_no, COUNT(*) current_count
            FROM tb_enrollment
            WHERE enrollment_status = 0
            GROUP BY course_no
        ) e ON e.course_no = c.course_no

        LEFT JOIN tb_enrollment s
               ON s.course_no = c.course_no
              AND s.student_user_no = #{studentUserNo}

        ORDER BY c.course_no DESC
        LIMIT #{startRow}, #{rowPerPage}
    </select>

    <!-- 전체 강의 row -->
    <select id="countCourseList" resultType="int">
        SELECT COUNT(*)
        FROM tb_course
    </select>

</mapper>
