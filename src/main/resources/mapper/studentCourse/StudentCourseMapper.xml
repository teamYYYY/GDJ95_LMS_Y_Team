<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.lms.mapper.studentCourse.StudentCourseMapper">

    <!-- 학생용 공지 목록 -->
    <select id="selectStudentCourseNoticeList"
            resultType="com.example.lms.dto.StudentCourseNoticeDTO">
        SELECT
            n.course_notice_no AS courseNoticeNo,
            n.course_no AS courseNo,
            n.course_notice_title AS courseNoticeTitle,
            u.user_name AS writerUserName,
            n.course_notice_view_count AS courseNoticeViewCount,
            DATE_FORMAT(n.createdate, '%Y-%m-%d') AS createdate
        FROM tb_course_notice n
        LEFT JOIN tb_sysuser u ON n.writer_user_no = u.user_no
        WHERE n.course_no = #{courseNo}
        ORDER BY n.createdate DESC
        LIMIT #{startRow}, #{rowPerPage}
    </select>

    <!-- 전체 개수 -->
    <select id="selectStudentCourseNoticeTotal" resultType="int">
        SELECT COUNT(*) 
        FROM tb_course_notice
        WHERE course_no = #{courseNo}
    </select>

    <!-- 공지 상세 -->
    <select id="selectStudentCourseNoticeDetail"
            resultType="com.example.lms.dto.StudentCourseNoticeDTO">
        SELECT
            n.course_notice_no AS courseNoticeNo,
            n.course_no AS courseNo,
            n.course_notice_title AS courseNoticeTitle,
            n.course_notice_content AS courseNoticeContent,
            u.user_name AS writerUserName,
            n.course_notice_view_count AS courseNoticeViewCount,
            DATE_FORMAT(n.createdate, '%Y-%m-%d %H:%i:%s') AS createdate
        FROM tb_course_notice n
        LEFT JOIN tb_sysuser u ON n.writer_user_no = u.user_no
        WHERE n.course_notice_no = #{courseNoticeNo}
    </select>

    <!-- 조회수 증가 -->
    <update id="updateStudentCourseNoticeViewCount">
        UPDATE tb_course_notice
        SET course_notice_view_count = course_notice_view_count + 1
        WHERE course_notice_no = #{courseNoticeNo}
    </update>

    <!-- 내 수강 과목 목록 -->
    <select id="selectMyCourseList"
            resultType="com.example.lms.dto.StudentCourseDTO">

        SELECT
              c.course_no        AS courseNo
            , c.course_name      AS courseName
            , u.user_name        AS professorName
            , d.dept_name        AS deptName
            , c.course_score     AS courseScore
            , c.course_capacity  AS courseCapacity

            , (SELECT t.course_time_yoil  FROM tb_course_time t WHERE t.course_no = c.course_no ORDER BY t.course_time_yoil LIMIT 1) AS courseTimeYoil
            , (SELECT t.course_time_start FROM tb_course_time t WHERE t.course_no = c.course_no ORDER BY t.course_time_yoil LIMIT 1) AS courseTimeStart
            , (SELECT t.course_time_end   FROM tb_course_time t WHERE t.course_no = c.course_no ORDER BY t.course_time_yoil LIMIT 1) AS courseTimeEnd

        FROM tb_enrollment e
        INNER JOIN tb_course c    ON c.course_no        = e.course_no
        LEFT JOIN tb_sysuser u    ON u.user_no          = c.professor_user_no
        LEFT JOIN tb_dept d       ON d.dept_code        = c.dept_code
        WHERE e.student_user_no   = #{studentUserNo}
          AND e.enrollment_status = 0
        ORDER BY c.course_no DESC
    </select>

    <!-- 수강신청 리스트 (필터 + 페이징) -->
    <select id="selectCourseListForStudentFiltered"
            resultType="com.example.lms.dto.StudentCourseDTO">

        SELECT
              c.course_no        AS courseNo
            , c.course_name      AS courseName
            , u.user_name        AS professorName
            , d.dept_name        AS deptName
            , c.course_score     AS courseScore
            , c.course_capacity  AS courseCapacity

            , (SELECT COUNT(*) FROM tb_enrollment e WHERE e.course_no = c.course_no AND e.enrollment_status = 0) AS currentCount
            , ((SELECT COUNT(*) FROM tb_enrollment e WHERE e.course_no = c.course_no AND e.enrollment_status = 0) >= c.course_capacity) AS isFull

            , (SELECT t.course_time_yoil  FROM tb_course_time t WHERE t.course_no = c.course_no ORDER BY t.course_time_yoil LIMIT 1) AS courseTimeYoil
            , (SELECT t.course_time_start FROM tb_course_time t WHERE t.course_no = c.course_no ORDER BY t.course_time_yoil LIMIT 1) AS courseTimeStart
            , (SELECT t.course_time_end   FROM tb_course_time t WHERE t.course_no = c.course_no ORDER BY t.course_time_yoil LIMIT 1) AS courseTimeEnd

        FROM tb_course c
        LEFT JOIN tb_sysuser u ON u.user_no   = c.professor_user_no
        LEFT JOIN tb_dept d    ON d.dept_code = c.dept_code
        WHERE 1 = 1

        <if test="yoil != null and yoil != 0">
            AND EXISTS (SELECT 1 FROM tb_course_time t WHERE t.course_no = c.course_no AND t.course_time_yoil = #{yoil})
        </if>

        <if test="professor != null and professor != ''">
            AND u.user_name LIKE CONCAT('%', #{professor}, '%')
        </if>

        <if test="deptCode != null and deptCode != ''">
            AND d.dept_code = #{deptCode}
        </if>

        ORDER BY c.course_no DESC
        LIMIT #{startRow}, #{rowPerPage}
    </select>

    <!-- 필터 COUNT -->
    <select id="countCourseListFiltered" resultType="int">
        SELECT COUNT(*)
        FROM tb_course c
        LEFT JOIN tb_sysuser u ON u.user_no   = c.professor_user_no
        LEFT JOIN tb_dept d    ON d.dept_code = c.dept_code
        WHERE 1 = 1

        <if test="yoil != null and yoil != 0">
            AND EXISTS (SELECT 1 FROM tb_course_time t WHERE t.course_no = c.course_no AND t.course_time_yoil = #{yoil})
        </if>

        <if test="professor != null and professor != ''">
            AND u.user_name LIKE CONCAT('%', #{professor}, '%')
        </if>

        <if test="deptCode != null and deptCode != ''">
            AND d.dept_code = #{deptCode}
        </if>
    </select>

    <!-- 전체 강의 목록 -->
    <select id="selectCourseListForStudent"
            resultType="com.example.lms.dto.StudentCourseDTO">

        SELECT
              c.course_no        AS courseNo
            , c.course_name      AS courseName
            , u.user_name        AS professorName
            , d.dept_name        AS deptName
            , c.course_score     AS courseScore
            , c.course_capacity  AS courseCapacity

            , (SELECT t.course_time_yoil  FROM tb_course_time t WHERE t.course_no = c.course_no LIMIT 1) AS courseTimeYoil
            , (SELECT t.course_time_start FROM tb_course_time t WHERE t.course_no = c.course_no LIMIT 1) AS courseTimeStart
            , (SELECT t.course_time_end   FROM tb_course_time t WHERE t.course_no = c.course_no LIMIT 1) AS courseTimeEnd

            , IFNULL(e.current_count, 0) AS currentCount
            , (IFNULL(e.current_count, 0) >= c.course_capacity) AS isFull

            , s.enrollment_status AS myStatus

        FROM tb_course c
        LEFT JOIN tb_sysuser u ON u.user_no   = c.professor_user_no
        LEFT JOIN tb_dept d    ON d.dept_code = c.dept_code

        LEFT JOIN (
            SELECT course_no, COUNT(*) AS current_count
            FROM tb_enrollment
            WHERE enrollment_status = 0
            GROUP BY course_no
        ) e ON e.course_no = c.course_no

        LEFT JOIN (
            SELECT course_no, student_user_no, enrollment_status
            FROM tb_enrollment
            WHERE student_user_no = #{studentUserNo}
        ) s ON s.course_no = c.course_no

        ORDER BY c.course_no DESC
        LIMIT #{startRow}, #{rowPerPage}
    </select>

    <!-- 전체 강의 TOTAL COUNT -->
    <select id="countCourseList" resultType="int">
        SELECT COUNT(*) FROM tb_course
    </select>

    <!-- 시간표 -->
    <select id="selectStudentTimetable"
            resultType="com.example.lms.dto.StudentTimetableDTO">

        SELECT
              c.course_no         AS courseNo
            , c.course_name       AS courseName
            , c.course_classroom  AS courseClassroom
            , t.course_time_yoil  AS courseTimeYoil
            , t.course_time_start AS courseTimeStart
            , t.course_time_end   AS courseTimeEnd

        FROM tb_enrollment e
        INNER JOIN tb_course c      ON c.course_no = e.course_no
        INNER JOIN tb_course_time t ON t.course_no = c.course_no
        WHERE e.student_user_no   = #{studentUserNo}
          AND e.enrollment_status = 0
        ORDER BY t.course_time_yoil, t.course_time_start
    </select>

    <!-- 강의 상세 -->
    <select id="selectStudentCourseDetail"
            resultType="com.example.lms.dto.StudentCourseDetailDTO">

        SELECT
              c.course_no        AS courseNo
            , c.course_name      AS courseName
            , c.course_year      AS courseYear
            , c.course_semester  AS courseSemester
            , c.course_score     AS courseScore
            , c.course_capacity  AS courseCapacity
            , c.course_description AS courseDescription
            , c.course_classroom AS courseClassroom
            , d.dept_name        AS deptName
            , u.user_name        AS professorName

        FROM tb_course c
        LEFT JOIN tb_dept d    ON d.dept_code = c.dept_code
        LEFT JOIN tb_sysuser u ON u.user_no   = c.professor_user_no
        WHERE c.course_no = #{courseNo}
    </select>

    <!-- 강의 시간표 리스트 -->
    <select id="selectCourseTimeList"
            resultType="com.example.lms.dto.CourseTimeDTO">

        SELECT
              course_time_no    AS courseTimeNo
            , course_time_yoil  AS courseTimeYoil
            , course_time_start AS courseTimeStart
            , course_time_end   AS courseTimeEnd
        FROM tb_course_time
        WHERE course_no = #{courseNo}
        ORDER BY course_time_yoil, course_time_start
    </select>

    <!-- 강의 홈 기본 정보 -->
    <select id="selectCourseBasicInfo"
            resultType="com.example.lms.dto.StudentCourseHomeDTO">

        SELECT
              c.course_no         AS courseNo
            , c.course_name       AS courseName
            , u.user_name         AS professorName
            , c.course_score      AS courseScore
            , c.course_classroom  AS classroom
            , ct.course_time_yoil  AS courseTimeYoil
            , ct.course_time_start AS courseTimeStart
            , ct.course_time_end   AS courseTimeEnd
        FROM tb_course c
        LEFT JOIN tb_sysuser u     ON u.user_no   = c.professor_user_no
        LEFT JOIN tb_course_time ct ON ct.course_no = c.course_no
        WHERE c.course_no = #{courseNo}
        LIMIT 1
    </select>

    <!-- 강의 홈 - 최근 공지 -->
    <select id="selectRecentNotices"
            resultType="com.example.lms.dto.StudentCourseNoticeDTO">

        SELECT 
              course_notice_no AS courseNoticeNo
            , course_notice_title AS courseNoticeTitle
            , createdate
        FROM tb_course_notice
        WHERE course_no = #{courseNo}
        ORDER BY createdate DESC
        LIMIT 3
    </select>

    <!-- 강의 홈 - 과제 요약 -->
    <select id="selectAssignmentSummary"
	        resultType="com.example.lms.dto.StudentAssignmentListDTO">
	
	    SELECT
	          a.assignment_no AS assignmentNo
	        , a.assignment_title AS assignmentTitle
	        , a.assignment_due_date AS assignmentDeadline
	
	        , (
	            SELECT COUNT(*)
	            FROM tb_assignment_submission s
	            WHERE s.assignment_no = a.assignment_no
	              AND s.writer_user_no = #{studentUserNo}
	              AND s.assignment_submission_status = 0
	          ) > 0 AS submitted
	
	        , (
	            SELECT s.assignment_score
	            FROM tb_assignment_submission s
	            WHERE s.assignment_no = a.assignment_no
	              AND s.writer_user_no = #{studentUserNo}
	              AND s.assignment_submission_status = 0
	            LIMIT 1
	          ) AS assignmentScore
	
	    FROM tb_assignment a
	    WHERE a.course_no = #{courseNo}
	    ORDER BY a.assignment_due_date ASC
	    LIMIT 1
	</select>

    <!-- 강의 홈 - 출석 요약 -->
    <select id="selectAttendanceSummary"
	        resultType="com.example.lms.dto.AttendanceSummaryDTO">
	
	    SELECT 
		    SUM(CASE WHEN attendance_status = 1 THEN 1 ELSE 0 END) AS presentCount,
		    SUM(CASE WHEN attendance_status = 2 THEN 1 ELSE 0 END) AS lateCount,
		    SUM(CASE WHEN attendance_status = 0 THEN 1 ELSE 0 END) AS absentCount,
		    ROUND(
		        (
		            SUM(CASE WHEN attendance_status = 1 THEN 1 ELSE 0 END) +
		            SUM(CASE WHEN attendance_status = 2 THEN 1 ELSE 0 END) * 0.5
		        ) / NULLIF(COUNT(*),0) * 100 , 1
		    ) AS attendanceRate
		FROM tb_attendance
		WHERE student_user_no = #{studentUserNo}
		  AND course_no = #{courseNo};

	</select>

    <!-- 강의 홈 - 성적 요약 -->
    <select id="selectGradeSummary"
            resultType="com.example.lms.dto.GradeSummaryDTO">

        SELECT
              grade_value AS gradeValue
            , grade_score AS gradeScore
        FROM tb_grade
        WHERE course_no = #{courseNo}
          AND student_user_no = #{studentUserNo}
        LIMIT 1
    </select>

    <!-- 강의 홈 - 최근 질문 -->
	<select id="selectRecentQuestions"
	        resultType="com.example.lms.dto.StudentQuestionDTO">
	
	    SELECT 
	          q.course_question_no AS questionNo
	        , q.course_question_title AS questionTitle
	        , DATE_FORMAT(q.createdate, '%Y-%m-%d') AS createdate
	
	        , (
	            SELECT COUNT(*)
	            FROM tb_course_question_answer qa
	            WHERE qa.course_question_no = q.course_question_no
	          ) AS answerCount
	
	        , q.is_private AS privatePost  
	        , q.writer_user_no AS writerUserNo
	
	    FROM tb_course_question q
	    WHERE q.course_no = #{courseNo}
	    ORDER BY q.createdate DESC
	    LIMIT 3
	</select>

    <!-- 학과 리스트 -->
    <select id="selectDeptList"
            resultType="com.example.lms.dto.DeptDTO">

        SELECT
              dept_code AS deptCode
            , dept_name AS deptName
        FROM tb_dept
        ORDER BY dept_name
    </select>


    <!-- 학생용 과제 목록 -->
    <select id="selectAssignmentList"
            resultType="com.example.lms.dto.StudentAssignmentListDTO">

        SELECT
              a.assignment_no AS assignmentNo
            , a.assignment_title AS assignmentTitle
            , a.assignment_due_date AS assignmentDeadline

            , (
                SELECT COUNT(*)
                FROM tb_assignment_submission s
                WHERE s.assignment_no = a.assignment_no
                  AND s.writer_user_no = #{studentUserNo}
                  AND s.assignment_submission_status = 0
              ) > 0 AS submitted

            , (
                SELECT s.assignment_score
                FROM tb_assignment_submission s
                WHERE s.assignment_no = a.assignment_no
                  AND s.writer_user_no = #{studentUserNo}
                  AND s.assignment_submission_status = 0
                LIMIT 1
              ) AS assignmentScore

        FROM tb_assignment a
        WHERE a.course_no = #{courseNo}
        ORDER BY a.assignment_due_date ASC

    </select>
	
	<!-- 학생용 출석 상세 리스트(15주차 기준) -->
	<select id="selectAttendanceDetailList"
	        resultType="com.example.lms.dto.StudentAttendanceDTO">
	
	    SELECT 
	        t.week AS weekNo,
	        COALESCE(a.attendance_status, -1) AS attendanceStatus 
	    FROM (
	        SELECT 1 AS week UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL
	        SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL
	        SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL
	        SELECT 10 UNION ALL SELECT 11 UNION ALL SELECT 12 UNION ALL
	        SELECT 13 UNION ALL SELECT 14 UNION ALL SELECT 15
	    ) t
	    LEFT JOIN tb_attendance a
	        ON a.week_no = t.week
	       AND a.course_no = #{courseNo}
	       AND a.student_user_no = #{studentUserNo}
	    ORDER BY t.week;
	
	</select>

</mapper>