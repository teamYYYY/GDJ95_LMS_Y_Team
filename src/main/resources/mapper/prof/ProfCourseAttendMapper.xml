<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.lms.mapper.prof.ProfCourseAttendMapper">

	<!-- 주차 목록 -->
    <select id="selectWeekList" resultType="int">
        SELECT week_no
        FROM tb_course_week
        WHERE course_no = #{courseNo}
        ORDER BY week_no
    </select>

    <!-- 주차별 학생 출석 조회 -->
    <select id="selectCourseAttendList" resultType="com.example.lms.dto.ProfCourseAttendDTO">
        SELECT
            u.user_no AS studentUserNo,
            u.user_name AS studentName,
            u.user_id AS studentId,
            d.dept_name AS deptName,
            u.user_phone AS studentPhone,
            a.attendance_status AS attendanceStatus
        FROM tb_enrollment e
        JOIN tb_sysuser u ON e.student_user_no = u.user_no
        LEFT JOIN tb_dept d ON u.dept_code = d.dept_code
        LEFT JOIN tb_attendance a
               ON a.course_no = #{courseNo}
              AND a.student_user_no = e.student_user_no
              AND a.week_no = #{weekNo}
        WHERE e.course_no = #{courseNo}
        ORDER BY u.user_name
    </select> 

    <!-- 출석 입력/수정 -->
    <insert id="upsertCourseAttend">
        INSERT INTO tb_attendance (
            student_user_no, course_no, week_no, attendance_status, createdate
        ) VALUES (
            #{studentUserNo}, #{courseNo}, #{weekNo}, #{attendanceStatus}, NOW()
        )
        ON DUPLICATE KEY UPDATE
            attendance_status = #{attendanceStatus},
            updatedate = NOW();
    </insert>
</mapper>