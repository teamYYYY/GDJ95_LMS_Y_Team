<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°œì¸ì •ë³´ê´€ë¦¬ | í•™ì‚¬ê´€ë¦¬ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #F5F7FA;
        }
        .admin-hero-bg {
            background-image: linear-gradient(to right, rgba(37, 99, 235, 0.9), rgba(30, 64, 175, 0.8)), url('https://images.unsplash.com/photo-1562774053-701939374585?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
            background-position: center;
        }
        .input-readonly {
            background-color: #F8F9FA;
            border-color: #E5E7EB;
            color: #6B7280;
            cursor: default;
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white border-b border-gray-200">
        <div class="max-w-screen-2xl mx-auto py-3 px-6 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white">
                    <i class="fa-solid fa-graduation-cap text-lg"></i>
                </div>
                <h1 class="text-lg font-bold text-gray-800">í•™ì‚¬ê´€ë¦¬ì‹œìŠ¤í…œ <span class="text-sm font-medium text-gray-500 ml-1">ê´€ë¦¬ì í˜ì´ì§€</span></h1>
            </div>
            <div class="text-sm text-gray-600 flex items-center gap-4">
                <p>{{userInfo.userName}}ë‹˜ ë¡œê·¸ì¸ ì¤‘ì…ë‹ˆë‹¤</p> 
                <a href="/logout" class="text-red-500 hover:text-red-600 transition flex items-center gap-1">
                    <i class="fa-solid fa-right-from-bracket text-xs"></i> ë¡œê·¸ì•„ì›ƒ
                </a>
            </div>
        </div>
    </header>

    <div class="admin-hero-bg h-40 p-8 text-white">
        <div class="max-w-screen-2xl mx-auto h-full flex flex-col justify-end">
            <h2 class="text-3xl font-bold">ê°œì¸ì •ë³´ê´€ë¦¬</h2>
            <p class="text-sm text-gray-200 mt-2">ê°œì¸ ì •ë³´ ì¡°íšŒ ë° ìˆ˜ì •</p>
        </div>
    </div>

    <div class="flex min-h-[calc(100vh-16rem)]">
        
        <aside class="w-64 bg-white border-r border-gray-200 shadow-md flex-shrink-0">
            <nav class="p-4 space-y-1">
                <a href="/myInfo/userInfo" class="flex items-center gap-3 p-3 rounded-lg bg-blue-50 text-blue-700 font-semibold transition">
                    <i class="fa-solid fa-user-gear w-5"></i> ê°œì¸ì •ë³´ê´€ë¦¬
                    <i class="fa-solid fa-chevron-right ml-auto text-xs"></i>
                </a>
                <a href="/admin/userManagement" class="flex items-center gap-3 p-3 rounded-lg text-gray-600 hover:bg-gray-50 transition">
                    <i class="fa-solid fa-users-gear w-5"></i> ì‹œìŠ¤í…œ ì‚¬ìš©ì ê´€ë¦¬
                </a>
                <a href="#" class="flex items-center gap-3 p-3 rounded-lg text-gray-600 hover:bg-gray-50 transition">
                    <i class="fa-solid fa-user-lock w-5"></i> ì‚¬ìš©ìê¶Œí•œê´€ë¦¬
                </a>
                <a href="#" class="flex items-center gap-3 p-3 rounded-lg text-gray-600 hover:bg-gray-50 transition">
                    <i class="fa-solid fa-book-open-reader w-5"></i> í•™ê³¼ê´€ë¦¬
                </a>
                <a href="#" class="flex items-center gap-3 p-3 rounded-lg text-gray-600 hover:bg-gray-50 transition">
                    <i class="fa-regular fa-bell w-5"></i> ê³µì§€ì‚¬í•­ê´€ë¦¬
                </a>
            </nav>
        </aside>

        <main class="flex-grow p-8">
            <div class="max-w-4xl bg-white p-8 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">ê°œì¸ì •ë³´ê´€ë¦¬</h2>
                <p class="text-gray-500 mb-6">ê°œì¸ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³  ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

                <form action="/updateInfo" method="POST" class="space-y-6">
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">ê¸°ë³¸ ì •ë³´</h3>
                    <p class="text-sm text-gray-500 -mt-2">íšŒì› ê¸°ë³¸ ì •ë³´ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-700">í•™ë²ˆ/êµë²ˆ/ì‚¬ë²ˆ (ID)</label>
                            <input type="text" value="{{userInfo.userId}}" readonly class="w-full px-4 py-2 border rounded-lg input-readonly">
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-700">ì„±ëª…</label>
                            <input type="text" value="{{userInfo.userName}}" readonly class="w-full px-4 py-2 border rounded-lg input-readonly">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-700">ê¶Œí•œ</label>
                            <input type="text" value="{{userInfo.authName}}" readonly class="w-full px-4 py-2 border rounded-lg input-readonly">
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-700">ë¹„ë°€ë²ˆí˜¸</label>
                            <div class="flex items-center gap-2" id="passwordChangeContainer">
                                <input type="password" value="********" readonly class="w-full px-4 py-2 border rounded-lg input-readonly">
                                <button type="button" id="passwordChangeBtn" class="px-3 py-2 bg-blue-50 hover:bg-blue-100 text-blue-600 text-sm rounded-lg transition flex-shrink-0 border border-blue-200">
                                    <i class="fa-solid fa-key mr-1"></i> ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-700">ì†Œì†(í•™ê³¼)</label>
                            <input type="text" value="{{userInfo.deptName}}" readonly class="w-full px-4 py-2 border rounded-lg input-readonly">
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-700">ì†Œì†ìƒíƒœ</label>
                            <input type="text" value="{{userInfo.statusName}}" readonly class="w-full px-4 py-2 border rounded-lg input-readonly">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-1">
                            <label for="userEmail" class="block text-sm font-medium text-gray-700">ì´ë©”ì¼</label>
                            <input type="email" id="userEmail" name="userEmail" value="{{userInfo.userEmail}}" maxlength="50" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 input-readonly modify-field" readonly>
                        </div>
                        <div class="space-y-1">
                            <label for="userPhone" class="block text-sm font-medium text-gray-700">ì—°ë½ì²˜</label>
                            <input type="tel" id="userPhone" name="userPhone" value="{{userInfo.userPhone}}" maxlength="11" oninput="this.value = this.value.replace(/[^0-9]/g, '')" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 input-readonly modify-field" readonly>
                        </div>
                    </div>
                    
                    <div class="space-y-1">
                        <label class="block text-sm font-medium text-gray-700">ìš°í¸ë²ˆí˜¸</label>
                        <input type="text" id="userZipcode" name="userZipcode" value="{{userInfo.userZipcode}}" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '')" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 input-readonly modify-field" readonly>
                    </div>

                    <div class="space-y-1">
                        <label for="userAddress" class="block text-sm font-medium text-gray-700">ì£¼ì†Œ</label>
                        <input type="text" id="userAddress" name="userAddr" value="{{userInfo.userAddr}}" maxlength="100" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 input-readonly modify-field" readonly>
                    </div>
                    
                    <div class="space-y-1">
                        <label for="userAddressDetail" class="block text-sm font-medium text-gray-700">ìƒì„¸ ì£¼ì†Œ</label>
                        <input type="text" id="userAddressDetail" name="userAddrDetail" value="{{userInfo.userAddrDetail}}" maxlength="100" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 input-readonly modify-field" readonly>
                    </div>
                    
                    <div id="modeToggleBtn" class="pt-4 flex justify-end gap-3">
                        <button type="button" onclick="enterEditMode()" class="px-5 py-2.5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition flex items-center gap-1">
                            <i class="fa-solid fa-pen-to-square"></i> ê°œì¸ì •ë³´ ë³€ê²½
                        </button>
                    </div>
                    
                    <div id="actionButtons" class="pt-4 flex justify-end gap-3 hidden">
                        <button type="button" onclick="cancelEditMode()" class="px-5 py-2.5 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition">ì·¨ì†Œ</button>
                        <button type="submit" class="px-5 py-2.5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition flex items-center gap-1">
                            <i class="fa-solid fa-floppy-disk"></i> ì €ì¥
                        </button>
                    </div>

                </form>
            </div>
        </main>
    </div>
    
    <div id="passwordModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 relative">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal()">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <h3 class="text-lg font-bold mb-4 border-b pb-2">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
            <p class="text-sm text-gray-500 mb-4">ë³´ì•ˆì„ ìœ„í•´ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê³  ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
            
            <form id="passwordChangeForm" class="space-y-4">
                <div>
                    <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-1">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="currentPassword" name="currentPassword" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label for="userNewPassword" class="block text-sm font-medium text-gray-700 mb-1">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="userNewPassword" name="userNewPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700 mb-1">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input type="password" id="confirmNewPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
                
                <div class="pt-3 flex justify-end gap-3">
                    <button type="button" onclick="closeModal()" class="px-5 py-2.5 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition">ì·¨ì†Œ</button>
                    <button type="submit" class="px-5 py-2.5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition">ì €ì¥</button>
                </div>
                <p id="passwordError" class="text-red-500 text-sm hidden mt-2"></p>
            </form>
        </div>
    </div>

    <script>
        // Flash Attributeë¡œ ì „ë‹¬ëœ ë©”ì‹œì§€ ë³€ìˆ˜
        const FLASH_MESSAGE = '{{#message}}{{message}}{{/message}}';
        const FLASH_ERROR = '{{#error}}{{error}}{{/error}}';

        // === DOM ìš”ì†Œ ===
        const modal = document.getElementById('passwordModal');
        const changeBtn = document.getElementById('passwordChangeBtn');
        const passwordChangeForm = document.getElementById('passwordChangeForm');
        const passwordError = document.getElementById('passwordError');
        const toggleBtn = document.getElementById('modeToggleBtn');
        const actionBtns = document.getElementById('actionButtons');
        const editableFields = document.querySelectorAll('.modify-field'); 
        const passwordChangeContainer = document.getElementById('passwordChangeContainer');
        
        // ì·¨ì†Œ ì‹œ ì›ë˜ ê°’ ë³µì›ì„ ìœ„í•œ ì €ì¥ì†Œ
        const originalValues = {};
        editableFields.forEach(field => {
            originalValues[field.id] = field.value;
        });

        // === ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ í•¨ìˆ˜ ===
        changeBtn.addEventListener('click', () => {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            passwordError.classList.add('hidden');
        });

        function closeModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            passwordChangeForm.reset();
        }
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
        
        // === í¸ì§‘ ëª¨ë“œ ì „í™˜ í•¨ìˆ˜ ===
        function enterEditMode() {
            editableFields.forEach(field => {
                field.removeAttribute('readonly'); 
                field.classList.remove('input-readonly');
                field.classList.add('bg-white');
            });

            toggleBtn.classList.add('hidden');
            actionBtns.classList.remove('hidden');
            passwordChangeContainer.classList.add('hidden');
        }

        function cancelEditMode() {
            editableFields.forEach(field => {
                field.setAttribute('readonly', true);
                field.classList.add('input-readonly');
                field.classList.remove('bg-white');
                
                field.value = originalValues[field.id]; 
            });

            actionBtns.classList.add('hidden');
            toggleBtn.classList.remove('hidden');
            passwordChangeContainer.classList.remove('hidden');
            
            if (window.history.replaceState) {
                const url = new URL(window.location);
                url.searchParams.delete('edit');
                window.history.replaceState({path: url.href}, '', url.href);
            }
        }
        
        // === í˜ì´ì§€ ë¡œë“œ ì‹œ Flash Message ë° í¸ì§‘ ëª¨ë“œ ì²˜ë¦¬ ===
        document.addEventListener('DOMContentLoaded', () => {
            
            if (FLASH_MESSAGE && FLASH_MESSAGE !== '') {
                alert(FLASH_MESSAGE);
            } 
            
            if (FLASH_ERROR && FLASH_ERROR !== '') {
                alert(FLASH_ERROR);
            }

            const urlParams = new URLSearchParams(window.location.search);
            const isEditMode = urlParams.get('edit') === 'true';

            if (isEditMode || (FLASH_ERROR && FLASH_ERROR !== '')) {
                enterEditMode();
            }
        });


        // === ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ AJAX ì œì¶œ ì²˜ë¦¬ ===
        passwordChangeForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('userNewPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (newPassword !== confirmNewPassword) {
                passwordError.textContent = "ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                passwordError.classList.remove('hidden');
                return;
            }
            
            if (currentPassword === newPassword) {
                passwordError.textContent = "í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ë™ì¼í•©ë‹ˆë‹¤.";
                passwordError.classList.remove('hidden');
                return;
            }

            passwordError.classList.add('hidden');
            
            const data = {
                userPassword: currentPassword, 
                userNewPassword: newPassword
            };

            try {
                const response = await fetch('/modifyPassword', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message); 
                    closeModal();
                } else {
                    passwordError.textContent = result.message; 
                    passwordError.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error:', error);
                passwordError.textContent = "ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                passwordError.classList.remove('hidden');
            }
        });
        
        // === ğŸš¨ ê°œì¸ì •ë³´ ë³€ê²½ í¼ ìœ íš¨ì„± ê²€ì‚¬ ë¡œì§ (ìƒˆë¡œ ì¶”ê°€/ìˆ˜ì •ëœ ë¶€ë¶„) ===
        const infoUpdateForm = document.querySelector('form[action="/updateInfo"]');
        
        infoUpdateForm.addEventListener('submit', function(e) {
            const email = document.getElementById('userEmail');
            const phone = document.getElementById('userPhone');
            const zip = document.getElementById('userZipcode');
            const addr = document.getElementById('userAddress');
            const detail = document.getElementById('userAddressDetail');

            // 1. ë¹ˆ ê°’ ì²´í¬ (DB Not Null ë°©ì§€)
            if (!email.value.trim() || !phone.value.trim() || !zip.value.trim() || !addr.value.trim() || !detail.value.trim()) {
                alert("ëª¨ë“  ì •ë³´ëŠ” í•„ìˆ˜ ì…ë ¥ê°’ì…ë‹ˆë‹¤. ë¹ˆ ì¹¸ì„ ì±„ì›Œì£¼ì„¸ìš”.");
                e.preventDefault(); // ì „ì†¡ ë§‰ê¸°
                return;
            }

            // 2. ì´ë©”ì¼ í˜•ì‹ ì²´í¬
            const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (!emailPattern.test(email.value)) {
                alert("ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
                email.focus();
                e.preventDefault();
                return;
            }

            // 3. ì „í™”ë²ˆí˜¸ ê¸¸ì´ ì²´í¬ (ìµœì†Œ 9ìë¦¬ ì´ìƒì€ ë˜ì–´ì•¼ ì •ìƒ ë²ˆí˜¸ë¡œ ê°„ì£¼)
            if (phone.value.length < 9) {
                 alert("ì „í™”ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìµœì†Œ 9ìë¦¬)");
                 phone.focus();
                 e.preventDefault();
                 return;
            }
            
            // 4. ìš°í¸ë²ˆí˜¸ ê¸¸ì´ ì²´í¬ (ìµœì†Œ 5ì ì´ìƒ - ëŒ€í•œë¯¼êµ­ ìš°í¸ë²ˆí˜¸ ê¸°ì¤€)
            if (zip.value.length < 5) {
                 alert("ìš°í¸ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìµœì†Œ 5ìë¦¬)");
                 zip.focus();
                 e.preventDefault();
                 return;
            }
            
        });
        // =======================================================
    </script>
</body>
</html>