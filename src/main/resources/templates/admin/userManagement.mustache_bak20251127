<script>
    // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
    const batchModal = document.getElementById('batchUploadModal');
    const userCrudModal = document.getElementById('userCrudModal');
    const userForm = document.getElementById('userForm');
    const modalTitle = document.getElementById('modalTitle');
    const modalSubtitle = document.getElementById('modalSubtitle');
    
    const registerBtns = document.getElementById('registerButtons');
    const detailBtns = document.getElementById('detailButtons');
    const editBtns = document.getElementById('editBtns');
    
    const passwordFieldDiv = document.getElementById('passwordField');
    const passwordInput = document.getElementById('userPassword');
    const userIdInput = document.getElementById('userId');
    
    // [AJAX í†µì‹  ë° ëª©ë¡ ê°±ì‹ ì„ ìœ„í•œ ë³€ìˆ˜]
    const userListBody = document.getElementById('userListBody');
    const searchConditionInput = document.getElementById('searchCondition');
    const searchBtn = document.getElementById('searchBtn');
    const retireSelectedBtn = document.getElementById('retireSelectedBtn');
    const totalCountDisplay = document.getElementById('totalCountDisplay');
    const paginationDiv = document.getElementById('pagination'); 
    
    let originalDetailData = {}; 
    
    // input-field í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ëª¨ë“  ì…ë ¥/ì„ íƒ í•„ë“œ (ìˆ¨ê¹€ í•„ë“œ ì œì™¸)
    const inputFields = document.querySelectorAll('#userCrudModal .input-field');

	 // ------------------------
	 // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜: í¼ì— ë°ì´í„° ë°”ì¸ë”© (ìˆ˜ì •ëœ ì½”ë“œ)
	 // ------------------------
	 function bindFormData(data) {
	     for (const key in data) {
	         const input = document.getElementById(key);
	         
	         // ğŸš¨ í¼ í•„ë“œê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ (input === null) ê±´ë„ˆëœë‹ˆë‹¤.
	         if (input) { 
	             // null ë˜ëŠ” undefined ê°’ì€ ë¹ˆ ë¬¸ìì—´ë¡œ ì„¤ì •í•˜ì—¬ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
	             input.value = (data[key] === null || data[key] === undefined) ? '' : data[key].toString(); 
	         } 
	         // ğŸ’¡ ì£¼ì˜: ë§Œì•½ ì„œë²„ ë°ì´í„°ì— ì¡´ì¬í•˜ì§€ë§Œ HTMLì— ì—†ëŠ” í•„ë“œê°€ ë§ë‹¤ë©´,
	         // ì´ ë¡œì§ì€ ì˜¤ë¥˜ëŠ” í•´ê²°í•˜ì§€ë§Œ, í•´ë‹¹ í•„ë“œì˜ ë°”ì¸ë”©ì€ ë¬´ì‹œë©ë‹ˆë‹¤.
	         // ì´ ê²½ìš°, ì„œë²„ ë°ì´í„° í•„ë“œì™€ HTML ID ëª©ë¡ì„ ëŒ€ì¡°í•´ì•¼ í•©ë‹ˆë‹¤.
	     }
	     
	     // ğŸš¨ ê°œë³„ í•„ë“œ ì²˜ë¦¬ì—ë„ ì•ˆì „ì„± ì²´í¬ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤. (userNo)
	     const userNoInput = document.getElementById('userNo');
	     if (userNoInput) {
	         userNoInput.value = data.userNo || ''; 
	     }
	     
	     // ğŸš¨ ê°œë³„ í•„ë“œ ì²˜ë¦¬ì—ë„ ì•ˆì „ì„± ì²´í¬ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤. (passwordInput)
	     if (passwordInput) {
	         passwordInput.value = '********'; 
	         passwordInput.setAttribute('type', 'text');
	     }
	 }

    // ------------------------
    // ğŸ’¡ ì¶”ê°€ëœ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜: ì…ë ¥ í•„ë“œ ì½ê¸° ì „ìš© ìƒíƒœ í† ê¸€
    // ------------------------
    function toggleInputReadOnly(isReadOnly, preservePassword) {
        inputFields.forEach(input => {
            if (input.id !== 'userNo' && input.id !== 'userId') {
                input.readOnly = isReadOnly;
                input.disabled = isReadOnly;
                
                if (isReadOnly) {
                    input.classList.add('input-readonly');
                } else {
                    input.classList.remove('input-readonly');
                }
            }
        });

        // ë¹„ë°€ë²ˆí˜¸ í•„ë“œ ì²˜ë¦¬
        if (!preservePassword) {
            passwordInput.readOnly = isReadOnly;
            passwordInput.disabled = isReadOnly;
            if (isReadOnly) {
                passwordInput.classList.add('input-readonly');
            } else {
                passwordInput.classList.remove('input-readonly');
            }
        }
    }
    
    // ------------------------
    // ğŸ’¡ ì¶”ê°€ëœ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜: ì‚¬ìš©ì ëª©ë¡ í…Œì´ë¸” ë Œë”ë§
    // ------------------------
    function renderUserTable(userList) {
        let html = '';
        
        const statusMap = {
            '0': { name: 'ì‚¬ìš©ëŒ€ê¸°', class: 'text-blue-600' }, 
            '1': { name: 'ì‚¬ìš©ì¤‘', class: 'text-green-600' }, 
            '2': { name: 'ë¯¸ì‚¬ìš©', class: 'text-orange-600' }, 
            '3': { name: 'íì§€', class: 'text-red-600' }, 
        };
        
        if (userList && userList.length > 0) {
            userList.forEach((user) => {
                const statusInfo = statusMap[user.userStatus] || { name: 'ì•Œ ìˆ˜ ì—†ìŒ', class: 'text-gray-500' };
                const statusClass = statusInfo.class;
                const statusName = statusInfo.name;
                
                html += `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-center"><input type="checkbox" name="selectedUser" data-user-no="${user.userNo}"></td>
                        <td class="px-4 py-3 whitespace-nowrap text-center text-sm text-gray-500">${user.userNo}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                            <a href="#" onclick="openUserDetailModal('${user.userId}')" class="text-blue-600 hover:underline">${user.userId}</a>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800">${user.userName}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800">${user.userEmail || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800">${user.deptName || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-center text-sm text-blue-600">${user.authName}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-center text-sm ${statusClass}">${statusName}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-center text-sm text-gray-500">${user.createDate}</td>
                    </tr>
                `;
            });
        } else {
             html += `
                <tr>
                    <td colspan="9" class="px-4 py-3 whitespace-nowrap text-center text-gray-500">ì¡°íšŒëœ ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                </tr>
            `;
        }
        
        userListBody.innerHTML = html;
        // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì´ˆê¸°í™” ë° ë²„íŠ¼ ê°±ì‹ 
        const selectAll = document.getElementById('selectAll');
        if (selectAll) selectAll.checked = false;
        updateRetireButtonState();
    }


    // ------------------------
    // ğŸ’¡ ìµœì¢… í†µí•©ëœ í•¨ìˆ˜: renderPagination (ì¤‘ë³µ ì œê±° ë° ë²„ê·¸ í•´ê²°)
    // ------------------------
    function renderPagination(totalCount, currentPage, pageSize = 10) {
        const totalPages = Math.ceil(totalCount / pageSize);
        
        // ì´ ê°œìˆ˜ í‘œì‹œ ê°±ì‹ 
        totalCountDisplay.textContent = `ì´ ${totalCount}ëª…ì˜ ì‚¬ìš©ì`;
        
        if (totalPages <= 1) {
            paginationDiv.innerHTML = '';
            paginationDiv.style.display = 'none';
            return;
        }

        let html = '';
        html += '<nav class="flex items-center space-x-1">';
        
        // --- 1. í˜ì´ì§€ ë¸”ë¡ ê³„ì‚° (10ê°œ) ---
        const pagesPerBlock = 10;
        const currentBlock = Math.floor((currentPage - 1) / pagesPerBlock);
        const blockStart = currentBlock * pagesPerBlock + 1;
        const blockEnd = Math.min(blockStart + pagesPerBlock - 1, totalPages);
        
        
        // --- 2. ì´ì „ í˜ì´ì§€ ë²„íŠ¼ (â—€) ---
        const prevPage = currentPage - 1;
        // 1í˜ì´ì§€ì¼ ë•Œ ë²„íŠ¼ ë¹„í™œì„±í™”
        const prevDisabled = (currentPage === 1) ? 'opacity-50 cursor-not-allowed' : '';
        html += `<a href="#" data-page="${prevPage > 0 ? prevPage : 1}" 
                     class="page-link px-3 py-1 text-sm font-medium rounded-lg text-gray-700 hover:bg-gray-100 ${prevDisabled}">â—€</a>`;


        // --- 3. í˜ì´ì§€ ë²ˆí˜¸ ë§í¬ (ë¸”ë¡ ë‚´) ---
        for (let i = blockStart; i <= blockEnd; i++) {
            // í˜„ì¬ í˜ì´ì§€ì— í™œì„±í™” í´ë˜ìŠ¤ ì ìš© (íŒŒë€ìƒ‰)
            const activeClass = (i === currentPage) ? 'bg-blue-600 text-white' : 'text-gray-700 hover:bg-gray-100';
            html += `<a href="#" data-page="${i}" 
                       class="page-link px-3 py-1 text-sm font-medium rounded-lg ${activeClass}">${i}</a>`;
        }

        // --- 4. ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼ (â–¶) ---
        const nextPage = currentPage + 1;
        // ë§ˆì§€ë§‰ í˜ì´ì§€ì¼ ë•Œ ë²„íŠ¼ ë¹„í™œì„±í™”
        const nextDisabled = (currentPage === totalPages) ? 'opacity-50 cursor-not-allowed' : '';
        html += `<a href="#" data-page="${nextPage <= totalPages ? nextPage : totalPages}" 
                     class="page-link px-3 py-1 text-sm font-medium rounded-lg text-gray-700 hover:bg-gray-100 ${nextDisabled}">â–¶</a>`;
        
        
        html += '</nav>';
        
        paginationDiv.innerHTML = html;
        paginationDiv.style.display = 'flex';
        
        // --- 5. ì´ë²¤íŠ¸ ìœ„ì„ (í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬) ---
        paginationDiv.querySelectorAll('.page-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                
                // ğŸ’¡ ë²„ê·¸ í•´ê²° ë¡œì§: í´ë¦­ ëŒ€ìƒì´ ë‚´ë¶€ ìš”ì†Œì¼ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ê°€ì¥ ê°€ê¹Œìš´ <a> íƒœê·¸ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
                const clickedLink = e.target.closest('a.page-link');
                if (!clickedLink) return;

                const targetPage = parseInt(clickedLink.dataset.page);
                
                // ë¹„í™œì„±í™”ëœ ë²„íŠ¼ í´ë¦­ ë˜ëŠ” ë²”ìœ„ë¥¼ ë²—ì–´ë‚œ í˜ì´ì§€ í´ë¦­ ë¬´ì‹œ
                if (clickedLink.classList.contains('cursor-not-allowed') || targetPage < 1 || targetPage > totalPages) return;

                // searchAndRenderUser í•¨ìˆ˜ í˜¸ì¶œ
                if (typeof searchAndRenderUser === 'function') {
                    searchAndRenderUser(targetPage); 
                } else {
                     console.error("searchAndRenderUser í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            });
        });
    }

    // ------------------------
    // í•µì‹¬ í•¨ìˆ˜: ê²€ìƒ‰ ë° í˜ì´ì§€ ì´ë™ AJAX ìš”ì²­
    // ------------------------
    function searchAndRenderUser(pageNo) {
        const condition = searchConditionInput.value.trim();
        
        $.ajax({
            url: '/admin/searchUserInfo',
            type: 'GET',
            data: { 
                searchCondition: condition,
                currentPage: pageNo // í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸ ì „ì†¡
            },
            success: function(response) {
                if (response.status === 'success') {
                    renderUserTable(response.userList); // ğŸ’¡ ëª©ë¡ ê°±ì‹ 
                    // totalCount, currentPageë¥¼ ì‚¬ìš©í•˜ì—¬ í˜ì´ì§€ë„¤ì´ì…˜ UI ê°±ì‹ 
                    renderPagination(response.totalCount, response.currentPage);
                } else {
                    alert('ì‚¬ìš©ì ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            },
            error: function() {
                alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }


    // ------------------------
    // ëª¨ë‹¬ ì œì–´ í•¨ìˆ˜
    // ------------------------
    function openBatchUploadModal() {
        batchModal.classList.remove('hidden');
        batchModal.classList.add('flex');
    }

    function closeBatchUploadModal() {
        batchModal.classList.add('hidden');
        batchModal.classList.remove('flex');
    }
    
    function closeUserCrudModal() {
        userCrudModal.classList.add('hidden');
        userCrudModal.classList.remove('flex');
        userForm.reset();
        userIdInput.removeAttribute('readonly');
        userIdInput.classList.remove('input-readonly');
        
        // ğŸ’¡ ê°±ì‹ : ëª¨ë‹¬ ë‹«ì€ í›„ í˜ì´ì§€ë¥¼ 1í˜ì´ì§€ë¡œ ì´ë™í•˜ë©° ëª©ë¡ ê°±ì‹  (ì„œë²„ ìƒˆë¡œê³ ì¹¨ ëŒ€ì‹ )
        // location.reload(); ëŒ€ì‹  searchAndRenderUser(1)ì„ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
        location.reload(); 
    }

    function openRegisterModal() {
        userForm.reset();
        modalTitle.textContent = "ì‚¬ìš©ì ë“±ë¡";
        modalSubtitle.textContent = "* í‘œì‹œëŠ” í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤";
        toggleInputReadOnly(false, false); 
        registerBtns.classList.remove('hidden');
        detailBtns.classList.add('hidden');
        editBtns.classList.add('hidden');
        passwordInput.required = true; 
        userIdInput.removeAttribute('readonly'); 
        userCrudModal.classList.remove('hidden');
        userCrudModal.classList.add('flex');
    }

    function openUserDetailModal(userId) {
        $.ajax({
            url: '/admin/getUserDetail',
            type: 'GET',
            data: { userId: userId },
            success: function(response) {
                if (response.status === 'success') {
                    const data = response.data;
                    originalDetailData = data; 
                    bindFormData(data); 

                    modalTitle.textContent = "ì‚¬ìš©ì ìƒì„¸ ì •ë³´ (" + userId + ")";
                    modalSubtitle.textContent = "ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤. (ë³€ê²½ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìˆ˜ì • ê°€ëŠ¥)";
                    toggleInputReadOnly(true, true); 
                    detailBtns.classList.remove('hidden');
                    registerBtns.classList.add('hidden');
                    editBtns.classList.add('hidden');
                    userCrudModal.classList.remove('hidden');
                    userCrudModal.classList.add('flex');
                } else {
                    alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + response.message);
                }
            },
            error: function() {
                alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    function enterDetailEditMode() {
        modalTitle.textContent = "ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •";
        modalSubtitle.textContent = "ì •ë³´ë¥¼ ìˆ˜ì • í›„ ì €ì¥í•´ì£¼ì„¸ìš”. (ë¹„ë°€ë²ˆí˜¸ ë¯¸ì…ë ¥ ì‹œ ë³€ê²½ ì—†ìŒ)";
        toggleInputReadOnly(false, true); 
        editBtns.classList.remove('hidden');
        detailBtns.classList.add('hidden');
        registerBtns.classList.add('hidden');
        userIdInput.setAttribute('readonly', true);
        userIdInput.classList.add('input-readonly');
        passwordInput.setAttribute('type', 'password'); 
        passwordInput.removeAttribute('readonly');
        passwordInput.classList.remove('input-readonly');
        passwordInput.disabled = false;
        passwordInput.required = false; 
        passwordInput.value = ''; 
    }

    function cancelDetailEditMode() {
        bindFormData(originalDetailData); 
        modalTitle.textContent = "ì‚¬ìš©ì ìƒì„¸ ì •ë³´ (" + userIdInput.value + ")";
        modalSubtitle.textContent = "ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤. (ë³€ê²½ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìˆ˜ì • ê°€ëŠ¥)";
        toggleInputReadOnly(true, true); 
        detailBtns.classList.remove('hidden');
        editBtns.classList.add('hidden');
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeBatchUploadModal();
            closeUserCrudModal();
        }
    });
    
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (ì²´í¬ë°•ìŠ¤ ìƒíƒœ) - DOMContentLoaded ë°–ìœ¼ë¡œ ì´ë™í•˜ì—¬ ì „ì—­ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ í•¨
    function updateRetireButtonState() {
        const checkedCount = document.querySelectorAll('input[name="selectedUser"]:checked').length;
        retireSelectedBtn.disabled = checkedCount === 0;
    }


    // ------------------------
    // DOMContentLoaded ì´ë²¤íŠ¸ ë° AJAX ìš”ì²­
    // ------------------------
    document.addEventListener('DOMContentLoaded', () => {
        const selectAll = document.getElementById('selectAll');
        const retireBtn = document.getElementById('retireSelectedBtn'); 
        
        // 4. í˜ì´ì§€ ìµœì´ˆ ë¡œë”© ì‹œ í˜ì´ì§• ì´ˆê¸°í™”
        const initialTotalCount = {{totalCount}}; 
        const initialCurrentPage = {{currentPage}}; 

        if (initialTotalCount > 0) {
            renderPagination(initialTotalCount, initialCurrentPage);
        }
        
        // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        selectAll.addEventListener('change', (e) => {
            document.querySelectorAll('input[name="selectedUser"]').forEach(checkbox => checkbox.checked = e.target.checked);
            updateRetireButtonState();
        });

        document.addEventListener('change', (e) => {
             if (e.target.name === 'selectedUser') {
                updateRetireButtonState();
             }
        });
        
        // 1. í¼ ì œì¶œ ì´ë²¤íŠ¸ í•¸ë“¤ë§ (ë“±ë¡/ìˆ˜ì •)
        userForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const isRegisterMode = registerBtns.classList.contains('hidden') === false;
            const url = isRegisterMode ? '/admin/insertUserInfo' : '/admin/updateUserInfoByAdmin';

            const formData = $(this).serializeArray().reduce((obj, item) => {
                obj[item.name] = item.value;
                return obj;
            }, {});
            
            if (!isRegisterMode && formData.userPassword === '') {
                delete formData.userPassword;
            }

            if (isRegisterMode) {
                 delete formData.userNo;
            }

            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    alert(response.message);
                    if (response.status === 'success') {
                        closeUserCrudModal(); 
                    }
                },
                error: function() {
                    alert(isRegisterMode ? 'ì‚¬ìš©ì ë“±ë¡ ì¤‘ ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' : 'ì‚¬ìš©ì ìˆ˜ì • ì¤‘ ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        });
        
        // 2. ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        searchBtn.addEventListener('click', function() {
             // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ì€ ë¬´ì¡°ê±´ 1í˜ì´ì§€ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
             searchAndRenderUser(1);
        });

        // 3. ê³„ì • íì§€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        retireBtn.addEventListener('click', () => {
            const selectedUserNos = Array.from(document.querySelectorAll('input[name="selectedUser"]:checked'))
                .map(cb => parseInt(cb.getAttribute('data-user-no'))); 

            if(selectedUserNos.length === 0) {
                alert("íì§€í•  ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            if(confirm(`ì„ íƒëœ ${selectedUserNos.length}ëª…ì˜ ì‚¬ìš©ìë¥¼ ì •ë§ ê³„ì • íì§€(ìƒíƒœ ë³€ê²½) ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                
                $.ajax({
                    url: '/admin/modifySysUserStatusRetire',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ userNoList: selectedUserNos }), 
                    success: function(response) {
                        alert(response.message);
                        if (response.status === 'success') {
                            location.reload(); 
                        }
                    },
                    error: function() {
                        alert('ê³„ì • íì§€ ì²˜ë¦¬ ì¤‘ ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            }
        });
    });
</script>